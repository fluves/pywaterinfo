<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>pywaterinfo.waterinfo &mdash; pywaterinfo 0.8.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=fa44fd50" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=19f00094" />

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../_static/documentation_options.js?v=486e5634"></script>
        <script src="../../_static/doctools.js?v=9a2dae69"></script>
        <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            pywaterinfo
          </a>
              <div class="version">
                0.8.0
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Getting started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../installation.html">Installation</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">User guide</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../tutorial.html">Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cache.html">Caching</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../timeseriesgroupids.html">Group identifiers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/reference.html">Module Reference</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Developer guide</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../contributing.html">Contributing to pywaterinfo</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../contributing.html#development-guidelines">Development guidelines</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../logging.html">Logging</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../changelog.html">Changelog</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../authors.html">Authors</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../conduct.html">Code of conduct</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../license.html">License</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">pywaterinfo</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">pywaterinfo.waterinfo</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for pywaterinfo.waterinfo</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">pytz</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">requests</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">requests_cache</span>

    <span class="n">request_cache_support</span> <span class="o">=</span> <span class="kc">True</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">request_cache_support</span> <span class="o">=</span> <span class="kc">False</span>


<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">INFO:</span>

<span class="sd">https://download.waterinfo.be/tsmdownload/KiWIS/KiWIS?service=kisters&amp; \</span>
<span class="sd">    type=QueryServices&amp;format=html&amp;request=getrequestinfo</span>
<span class="sd">other KIWIS-python clients:</span>
<span class="sd">    - https://github.com/amacd31</span>
<span class="sd">    - https://gitlab.com/kisters/kisters.water.time_series</span>
<span class="sd">&quot;&quot;&quot;</span>


<span class="n">VMM_BASE</span> <span class="o">=</span> <span class="s2">&quot;https://download.waterinfo.be/tsmdownload/KiWIS/KiWIS&quot;</span>
<span class="n">VMM_AUTH</span> <span class="o">=</span> <span class="s2">&quot;http://download.waterinfo.be/kiwis-auth/token&quot;</span>
<span class="n">HIC_BASE</span> <span class="o">=</span> <span class="s2">&quot;https://hicws.vlaanderen.be/KiWIS/KiWIS&quot;</span>
<span class="n">HIC_AUTH</span> <span class="o">=</span> <span class="s2">&quot;https://hicwsauth.vlaanderen.be/auth&quot;</span>

<span class="c1"># Custom hard-coded fix for the decoding issue #1 of given returnfields</span>
<span class="n">DECODE_ERRORS</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;AV Quality Code Color&quot;</span><span class="p">,</span> <span class="s2">&quot;RV Quality Code Color&quot;</span><span class="p">]</span>

<span class="c1"># Default cache configuration</span>
<span class="n">CACHE_RETENTION</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">7</span><span class="p">)</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">KiwisException</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Raised when the KIWIS calls contain error&quot;&quot;&quot;</span>

    <span class="k">pass</span>


<span class="k">class</span> <span class="nc">WaterinfoException</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Raised when the Waterinfo data request inputs are wrong&quot;&quot;&quot;</span>

    <span class="k">pass</span>


<div class="viewcode-block" id="Waterinfo">
<a class="viewcode-back" href="../../api/reference.html#pywaterinfo.Waterinfo">[docs]</a>
<span class="k">class</span> <span class="nc">Waterinfo</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">provider</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;vmm&quot;</span><span class="p">,</span>
        <span class="n">token</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">proxies</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">cache</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Request data from waterinfo.be</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        provider : vmm | hic</span>
<span class="sd">            Define the origin of the data on waterinfo you&#39;re looking for. Either</span>
<span class="sd">            provided by VMM (vmm) or HIC (hic)</span>
<span class="sd">        token : str</span>
<span class="sd">            Token as provided by VMM on project-level.</span>
<span class="sd">        proxies: dict</span>
<span class="sd">            Dictionary mapping protocol or protocol and host to the URL of the proxy</span>
<span class="sd">            (e.g. {‘http’: ‘foo.bar:3128’, ‘http://host.name’: ‘foo.bar:4012’}) to be</span>
<span class="sd">            used on each Request</span>
<span class="sd">        cache : bool, default False</span>
<span class="sd">            If True, a cached session is used to make sure consecutive calls for the</span>
<span class="sd">            same data are stored in a local cache.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># TODO - add info on missing installation of requests-cache</span>

        <span class="c1"># set the base string linked to the data provider</span>
        <span class="k">if</span> <span class="n">provider</span> <span class="o">==</span> <span class="s2">&quot;vmm&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_base_url</span> <span class="o">=</span> <span class="n">VMM_BASE</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_auth_url</span> <span class="o">=</span> <span class="n">VMM_AUTH</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_datasource</span> <span class="o">=</span> <span class="s2">&quot;1&quot;</span>
        <span class="k">elif</span> <span class="n">provider</span> <span class="o">==</span> <span class="s2">&quot;hic&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_base_url</span> <span class="o">=</span> <span class="n">HIC_BASE</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_auth_url</span> <span class="o">=</span> <span class="n">HIC_AUTH</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_datasource</span> <span class="o">=</span> <span class="s2">&quot;4&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">WaterinfoException</span><span class="p">(</span><span class="s2">&quot;Provider is either &#39;vmm&#39; or &#39;hic&#39;.&quot;</span><span class="p">)</span>

        <span class="c1"># Use requests-cache session</span>
        <span class="k">if</span> <span class="n">cache</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">request_cache_support</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_request</span> <span class="o">=</span> <span class="n">requests_cache</span><span class="o">.</span><span class="n">CachedSession</span><span class="p">(</span>
                    <span class="n">cache_name</span><span class="o">=</span><span class="s2">&quot;pywaterinfo_cache.sqlite&quot;</span><span class="p">,</span>
                    <span class="n">use_memory</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                    <span class="n">cache_control</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                    <span class="n">expire_after</span><span class="o">=</span><span class="n">CACHE_RETENTION</span><span class="p">,</span>
                    <span class="n">stale_if_error</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                    <span class="n">use_cache_dir</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="n">proxies</span><span class="o">=</span><span class="n">proxies</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                    <span class="s2">&quot;The required packages to support caching are not &quot;</span>
                    <span class="s2">&quot;installed. Install them with &quot;</span>
                    <span class="s2">&quot;`pip install pywaterinfo[cache]`.&quot;</span>
                <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_request</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">Session</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">proxies</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="o">.</span><span class="n">proxies</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">proxies</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_proxies</span> <span class="o">=</span> <span class="n">proxies</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__default_args</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;service&quot;</span><span class="p">:</span> <span class="s2">&quot;kisters&quot;</span><span class="p">,</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;QueryServices&quot;</span><span class="p">,</span>
            <span class="s2">&quot;format&quot;</span><span class="p">:</span> <span class="s2">&quot;json&quot;</span><span class="p">,</span>
            <span class="s2">&quot;datasource&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_datasource</span><span class="p">,</span>
            <span class="s2">&quot;timezone&quot;</span><span class="p">:</span> <span class="s2">&quot;UTC&quot;</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_token_header</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">token</span><span class="p">:</span>
            <span class="c1"># Token request outside cached session</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_auth_url</span><span class="p">,</span>
                <span class="n">headers</span><span class="o">=</span><span class="p">{</span>
                    <span class="s2">&quot;Authorization&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Basic </span><span class="si">{</span><span class="n">token</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;scope&quot;</span><span class="p">:</span> <span class="s2">&quot;none&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;Content-Type&quot;</span><span class="p">:</span> <span class="s2">&quot;application/x-www-form-urlencoded&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;charset&quot;</span><span class="p">:</span> <span class="s2">&quot;UTF-8&quot;</span><span class="p">,</span>
                <span class="p">},</span>
                <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;grant_type&quot;</span><span class="p">:</span> <span class="s2">&quot;client_credentials&quot;</span><span class="p">},</span>
                <span class="n">proxies</span><span class="o">=</span><span class="n">proxies</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">res</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
            <span class="n">res_parsed</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_token_header</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;Authorization&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">res_parsed</span><span class="p">[</span><span class="s1">&#39;token_type&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">res_parsed</span><span class="p">[</span><span class="s1">&#39;access_token&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">}</span>
            <span class="n">expires_in</span> <span class="o">=</span> <span class="n">res_parsed</span><span class="p">[</span><span class="s2">&quot;expires_in&quot;</span><span class="p">]</span>
            <span class="n">expires_on</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">+</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span>
                <span class="n">seconds</span><span class="o">=</span><span class="n">expires_in</span>
            <span class="p">)</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Current token expires on </span><span class="si">{</span><span class="n">expires_on</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># request the API info from the waterinfo KIWIS service itself</span>
        <span class="n">query_param</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;request&quot;</span><span class="p">:</span> <span class="s2">&quot;getRequestInfo&quot;</span><span class="p">}</span>

        <span class="n">headers</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_token_header</span><span class="p">:</span>
            <span class="n">headers</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_token_header</span><span class="p">)</span>
        <span class="n">info</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request_kiwis</span><span class="p">(</span><span class="n">query_param</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_kiwis_info</span> <span class="o">=</span> <span class="n">info</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;Requests&quot;</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_default_params</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;format&quot;</span><span class="p">,</span> <span class="s2">&quot;returnfields&quot;</span><span class="p">,</span> <span class="s2">&quot;request&quot;</span><span class="p">]</span>

        <span class="c1"># clean up cache old entries (requests-cache only removes/updates</span>
        <span class="c1"># entries that are reused, so this remove piling too much cache.)</span>
        <span class="k">if</span> <span class="n">cache</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">expired</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;&lt;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> object, &quot;</span> <span class="sa">f</span><span class="s2">&quot;Query from </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_base_url</span><span class="si">!r}</span><span class="s2">&gt;&quot;</span>

<div class="viewcode-block" id="Waterinfo.clear_cache">
<a class="viewcode-back" href="../../api/reference.html#pywaterinfo.Waterinfo.clear_cache">[docs]</a>
    <span class="k">def</span> <span class="nf">clear_cache</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Clean up the cache.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span></div>


<div class="viewcode-block" id="Waterinfo.request_kiwis">
<a class="viewcode-back" href="../../api/reference.html#pywaterinfo.Waterinfo.request_kiwis">[docs]</a>
    <span class="k">def</span> <span class="nf">request_kiwis</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">headers</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;http call to waterinfo.be KIWIS API</span>

<span class="sd">        General call used to request information and data from waterinfo.be, providing</span>
<span class="sd">        error handling and json parsing. The service, type, format (json),</span>
<span class="sd">        datasource and timezone (UTC) are provided by default (but can be overridden</span>
<span class="sd">        by adding them to the query).</span>

<span class="sd">        Whereas specific methods are provided to support the queries getTimeseriesList,</span>
<span class="sd">        getTimeseriesValues, getTimeseriesValueLayer and getGroupList; this method</span>
<span class="sd">        can be used to use the other available queries as well.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        query : dict</span>
<span class="sd">            list of query options to be used together with the base string</span>
<span class="sd">        headers : dict</span>
<span class="sd">            authentication header for the call</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        parsed json object, full HTTP response</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        &gt;&gt;&gt; from pywaterinfo import Waterinfo</span>
<span class="sd">        &gt;&gt;&gt; vmm = Waterinfo(&quot;vmm&quot;)</span>
<span class="sd">        &gt;&gt;&gt; # get the API info/documentation from kiwis</span>
<span class="sd">        &gt;&gt;&gt; data, res = vmm.request_kiwis({&quot;request&quot;: &quot;getRequestInfo&quot;})</span>
<span class="sd">        &gt;&gt;&gt; data        #doctest: +ELLIPSIS</span>
<span class="sd">        [{&#39;Title&#39;: &#39;KISTERS QueryServices - Request Inform...}}}}}]</span>
<span class="sd">        &gt;&gt;&gt; res.status_code</span>
<span class="sd">        200</span>
<span class="sd">        &gt;&gt;&gt; # get the timeseries data from last day from time series 78124042</span>
<span class="sd">        &gt;&gt;&gt; data, res = vmm.request_kiwis({&quot;request&quot;: &quot;getTimeseriesValues&quot;,</span>
<span class="sd">        ...                                &quot;ts_id&quot;: &quot;78124042&quot;,</span>
<span class="sd">        ...                                &quot;period&quot;: &quot;P1D&quot;})</span>
<span class="sd">        &gt;&gt;&gt; data        #doctest: +ELLIPSIS</span>
<span class="sd">        [{&#39;ts_id&#39;: &#39;78124042&#39;...]]}]</span>
<span class="sd">        &gt;&gt;&gt; # get all stations starting with a P in the station_no</span>
<span class="sd">        &gt;&gt;&gt; data, res = vmm.request_kiwis({&quot;request&quot;: &quot;getStationList&quot;,</span>
<span class="sd">        ...                                &quot;station_no&quot;: &quot;P*&quot;})</span>
<span class="sd">        &gt;&gt;&gt; data        #doctest: +ELLIPSIS</span>
<span class="sd">        [[&#39;station_name&#39;...]]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># query input checks: valid parameters and formatting of the parameters period,</span>
        <span class="c1"># dateformat, returnfields</span>
        <span class="n">query</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span> <span class="n">value</span> <span class="k">for</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span> <span class="ow">in</span> <span class="n">query</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
        <span class="k">if</span> <span class="n">query</span><span class="p">[</span><span class="s2">&quot;request&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;getRequestInfo&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_check_query_parameters</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
        <span class="k">if</span> <span class="s2">&quot;period&quot;</span> <span class="ow">in</span> <span class="n">query</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_check_period_format</span><span class="p">(</span><span class="n">query</span><span class="p">[</span><span class="s2">&quot;period&quot;</span><span class="p">])</span>
        <span class="k">if</span> <span class="s2">&quot;dateformat&quot;</span> <span class="ow">in</span> <span class="n">query</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_check_return_date_format</span><span class="p">(</span><span class="n">query</span><span class="p">[</span><span class="s2">&quot;dateformat&quot;</span><span class="p">],</span> <span class="n">query</span><span class="p">[</span><span class="s2">&quot;request&quot;</span><span class="p">])</span>
        <span class="k">if</span> <span class="s2">&quot;returnfields&quot;</span> <span class="ow">in</span> <span class="n">query</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_check_return_fields_format</span><span class="p">(</span><span class="n">query</span><span class="p">[</span><span class="s2">&quot;returnfields&quot;</span><span class="p">],</span> <span class="n">query</span><span class="p">[</span><span class="s2">&quot;request&quot;</span><span class="p">])</span>

        <span class="c1"># User can overwrite the default arguments</span>
        <span class="n">defaults</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">key</span><span class="p">:</span> <span class="n">value</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__default_args</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">query</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="p">}</span>
        <span class="n">query</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">defaults</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">headers</span><span class="p">:</span>
            <span class="n">headers</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_token_header</span><span class="p">:</span>
            <span class="n">headers</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_token_header</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_base_url</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">query</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="n">proxies</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_proxies</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">res</span><span class="o">.</span><span class="n">status_code</span> <span class="o">!=</span> <span class="n">requests</span><span class="o">.</span><span class="n">codes</span><span class="o">.</span><span class="n">ok</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">KiwisException</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Waterinfo call returned </span><span class="si">{</span><span class="n">res</span><span class="o">.</span><span class="n">status_code</span><span class="si">}</span><span class="s2"> error &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;with the message </span><span class="si">{</span><span class="n">res</span><span class="o">.</span><span class="n">content</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">res</span><span class="o">.</span><span class="n">from_cache</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Request </span><span class="si">{</span><span class="n">res</span><span class="o">.</span><span class="n">url</span><span class="si">}</span><span class="s2"> reused from cache.&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Successful waterinfo API request with call </span><span class="si">{</span><span class="n">res</span><span class="o">.</span><span class="n">url</span><span class="si">}</span><span class="s2"> &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;(call to waterinfo.be with cache activated).&quot;</span>
                <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Successful waterinfo API request with call </span><span class="si">{</span><span class="n">res</span><span class="o">.</span><span class="n">url</span><span class="si">}</span><span class="s2"> &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;(call to waterinfo.be without cache activated).&quot;</span>
            <span class="p">)</span>

        <span class="n">parsed</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="nb">type</span><span class="p">(</span><span class="n">parsed</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">dict</span>
            <span class="ow">and</span> <span class="s2">&quot;type&quot;</span> <span class="ow">in</span> <span class="n">parsed</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
            <span class="ow">and</span> <span class="n">parsed</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;error&quot;</span>
        <span class="p">):</span>
            <span class="k">raise</span> <span class="n">KiwisException</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Waterinfo API returned an error:</span><span class="se">\n\t</span><span class="s2">Code: &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">parsed</span><span class="p">[</span><span class="s1">&#39;code&#39;</span><span class="p">]</span><span class="si">}</span><span class="se">\n\t</span><span class="s2">Message: </span><span class="si">{</span><span class="n">parsed</span><span class="p">[</span><span class="s1">&#39;message&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="n">parsed</span><span class="p">,</span> <span class="n">res</span></div>


    <span class="k">def</span> <span class="nf">_check_query_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check if all given parameters in the query are known to</span>
<span class="sd">        the KIWIS webservice&quot;&quot;&quot;</span>

        <span class="n">request</span> <span class="o">=</span> <span class="n">query</span><span class="p">[</span><span class="s2">&quot;request&quot;</span><span class="p">]</span>
        <span class="n">supported_parameters</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_kiwis_info</span><span class="p">[</span><span class="n">request</span><span class="p">][</span><span class="s2">&quot;QueryFields&quot;</span><span class="p">][</span><span class="s2">&quot;Content&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="s2">&quot;Optionalfields&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_kiwis_info</span><span class="p">[</span><span class="n">request</span><span class="p">]:</span>
            <span class="n">optional_parameters</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_kiwis_info</span><span class="p">[</span><span class="n">request</span><span class="p">][</span><span class="s2">&quot;Optionalfields&quot;</span><span class="p">][</span><span class="s2">&quot;Content&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">optional_parameters</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">parameter</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">query</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">parameter</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span>
                <span class="n">supported_parameters</span> <span class="o">|</span> <span class="n">optional_parameters</span> <span class="o">|</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_default_params</span><span class="p">)</span>
            <span class="p">):</span>
                <span class="k">raise</span> <span class="n">WaterinfoException</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Parameter &#39;</span><span class="si">{</span><span class="n">parameter</span><span class="si">}</span><span class="s2">&#39; not in requestInfo for </span><span class="si">{</span><span class="n">request</span><span class="si">}</span><span class="s2">. Check &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_base_url</span><span class="si">}</span><span class="s2">?service=kisters&amp;type=queryServices&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;&amp;request=getRequestInfo &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;for an overview of the documentation.&quot;</span>
                <span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_check_period_format</span><span class="p">(</span><span class="n">period_string</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check period string format</span>

<span class="sd">        Check if the format of the period is conform the specifications of</span>
<span class="sd">        the KIWIS webservice definition.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        period_string: str</span>
<span class="sd">            Input string according to format required by waterinfo:</span>
<span class="sd">            The period string is provided as P#Y#M#DT#H#M#S, with P defines `Period`,</span>
<span class="sd">            each # is an integer value and the codes define the number of...</span>
<span class="sd">            Y - years</span>
<span class="sd">            M - months</span>
<span class="sd">            D - days</span>
<span class="sd">            T required if information about sub-day resolution is present</span>
<span class="sd">            D - days</span>
<span class="sd">            H - hours</span>
<span class="sd">            M - minutes</span>
<span class="sd">            S - seconds</span>
<span class="sd">            Instead of D (days), the usage of W - weeks is possible as well</span>
<span class="sd">            Examples of valid period strings: P3D, P1Y, P1DT12H, PT6H, P1Y6M3DT4H20M30S.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        str period string itself if valid</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        &gt;&gt;&gt; _check_period_format(&quot;P2DT6H&quot;) # period of 2 days and 6 hours</span>
<span class="sd">        &gt;&gt;&gt; _check_period_format(&quot;P3D&quot;) # period of 3 days</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span>
            <span class="s2">&quot;^P(?=[0-9]+|T)[0-9]*Y?(?!M)[0-9]*M?(?![DW])[0-9]*[D,W]?(T)&quot;</span>
            <span class="s2">&quot;?(?(1)(?![H])[0-9]*H?(?![M])[0-9]*M?(?![S])[0-9]*S?|)$&quot;</span>
        <span class="p">)</span>
        <span class="n">valid</span> <span class="o">=</span> <span class="n">pattern</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">period_string</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">valid</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">WaterinfoException</span><span class="p">(</span>
                <span class="s2">&quot;The period string is not a valid expression. Examples of&quot;</span>
                <span class="s2">&quot; valid expressions are&quot;</span>
                <span class="s2">&quot; P3D, P1Y, P1DT12H, PT6H, P1Y6M3DT4H20M30S&quot;</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">period_string</span>

    <span class="k">def</span> <span class="nf">_check_return_date_format</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dateformat</span><span class="p">,</span> <span class="n">request</span><span class="o">=</span><span class="s2">&quot;getTimeseriesValues&quot;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check if the requested output date format is known to the KIWIS webservice&quot;&quot;&quot;</span>
        <span class="n">supported_formats</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_kiwis_info</span><span class="p">[</span><span class="n">request</span><span class="p">][</span><span class="s2">&quot;Dateformats&quot;</span><span class="p">][</span><span class="s2">&quot;Content&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">dateformat</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">supported_formats</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">WaterinfoException</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;The requested returned datetime </span><span class="si">{</span><span class="n">dateformat</span><span class="si">}</span><span class="s2"> format is not valid &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;as KIWIS input. The supported formats are </span><span class="si">{</span><span class="n">supported_formats</span><span class="si">}</span><span class="s2"> or &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;check </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_base_url</span><span class="si">}</span><span class="s2">?service=kisters&amp;type=queryServices&amp;&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;request=getRequestInfo for an overview of the documentation.&quot;</span>
            <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_check_return_fields_format</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">return_fields</span><span class="p">,</span> <span class="n">request</span><span class="o">=</span><span class="s2">&quot;getTimeseriesValues&quot;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check if the requested return_fields are known to the KIWIS webservice&quot;&quot;&quot;</span>
        <span class="n">return_fields</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">return_fields</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">))</span>  <span class="c1"># user requested</span>
        <span class="n">supported_fields</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_kiwis_info</span><span class="p">[</span><span class="n">request</span><span class="p">][</span><span class="s2">&quot;Returnfields&quot;</span><span class="p">][</span><span class="s2">&quot;Content&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="p">)</span>  <span class="c1"># api supported</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">return_fields</span> <span class="o">&lt;=</span> <span class="n">supported_fields</span><span class="p">:</span>
            <span class="n">invalid_fields</span> <span class="o">=</span> <span class="n">return_fields</span> <span class="o">-</span> <span class="n">supported_fields</span>
            <span class="k">raise</span> <span class="n">WaterinfoException</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Returnfield(s) </span><span class="si">{</span><span class="n">invalid_fields</span><span class="si">}</span><span class="s2"> not in requestInfo for </span><span class="si">{</span><span class="n">request</span><span class="si">}</span><span class="s2">. &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;The supported formats are </span><span class="si">{</span><span class="n">supported_fields</span><span class="si">}</span><span class="s2"> or check &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_base_url</span><span class="si">}</span><span class="s2">?service=kisters&amp;type=queryServices&amp;&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;request=getRequestInfo for an overview of the documentation.&quot;</span>
            <span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_parse_date</span><span class="p">(</span><span class="n">input_datetime</span><span class="p">,</span> <span class="n">timezone</span><span class="o">=</span><span class="s2">&quot;UTC&quot;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Evaluate date and transform to format accepted by KIWIS API</span>

<span class="sd">        Dates can be specified on a courser-than-day basis, but will always be</span>
<span class="sd">        transformed to start of... (year, month,...). For example, &#39;2007&#39; will be</span>
<span class="sd">        translated to &#39;20170101 00:00&#39;.</span>

<span class="sd">        Note, the input datetime of the KIWIS API is always CET (and is not tz-aware),</span>
<span class="sd">        we normalize everything to UTC by default. Hence, we interpret the user</span>
<span class="sd">        input as UTC, provide the input to the API as CET and request the returned</span>
<span class="sd">        output data as UTC. If the user provides a timezone, we interpret user input as</span>
<span class="sd">        the given timezone, do the request in CET and return the output data in the</span>
<span class="sd">        requested timezone.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        input_datetime : str</span>
<span class="sd">            datetime string</span>
<span class="sd">        timezone : str, default &#39;UTC&#39;</span>
<span class="sd">            user defined timezone to use</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">timezone</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">pytz</span><span class="o">.</span><span class="n">all_timezones</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">pytz</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">UnknownTimeZoneError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">timezone</span><span class="si">}</span><span class="s2"> is not a valid timezone string.&quot;</span>
            <span class="p">)</span>

        <span class="n">input_timestamp</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">input_datetime</span><span class="p">))</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">input_timestamp</span><span class="o">.</span><span class="n">tz</span><span class="p">:</span>  <span class="c1"># timestamp does not contain tz info</span>
            <span class="n">input_timestamp</span> <span class="o">=</span> <span class="n">input_timestamp</span><span class="o">.</span><span class="n">tz_localize</span><span class="p">(</span><span class="n">timezone</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">input_timestamp</span><span class="o">.</span><span class="n">tz_convert</span><span class="p">(</span><span class="s2">&quot;CET&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2"> %H:%M:%S&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_parse_period</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">period</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">timezone</span><span class="o">=</span><span class="s2">&quot;UTC&quot;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check the from/to/period arguments when requesting</span>

<span class="sd">        Valid for getTimeseriesValues and getGraph. Handle the information of</span>
<span class="sd">        provided date information on the period and provide</span>
<span class="sd">        feedback to the user. Valid combinations of the arguments are:</span>
<span class="sd">        from/to, from/period, to/period, period, from:</span>

<span class="sd">        - ``from`` and ``to``: will return the requested range</span>
<span class="sd">        - ``from`` and ``period``: will return the given period starting at</span>
<span class="sd">          the from date</span>
<span class="sd">        - ``to`` and ``period``: will return the given period backdating</span>
<span class="sd">          from the to date</span>
<span class="sd">        - ``period``: will return the given period backdating from the current</span>
<span class="sd">          system time</span>
<span class="sd">        - ``from`` : will return all data starting at the given from date until</span>
<span class="sd">          the current system time</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        start : str</span>
<span class="sd">            valid datetime string representation as defined in the KIWIS getRequestInfo</span>
<span class="sd">        end : str</span>
<span class="sd">            valid datetime string representation as defined in the KIWIS getRequestInfo</span>
<span class="sd">        period : str</span>
<span class="sd">            period input string according to format required by waterinfo</span>
<span class="sd">        timezone: str, default &#39;UTC&#39;</span>
<span class="sd">            User defined timezone to use.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        dict with the relevant period/date information</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># if none of 3 provided, error</span>
        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">start</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="n">end</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="n">period</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">WaterinfoException</span><span class="p">(</span>
                <span class="s2">&quot;Date information should be provided by a combination of 2 &quot;</span>
                <span class="s2">&quot;parameters out of from / to / period&quot;</span>
            <span class="p">)</span>

        <span class="c1"># if all 3 provided, error</span>
        <span class="k">if</span> <span class="n">start</span> <span class="ow">and</span> <span class="n">end</span> <span class="ow">and</span> <span class="n">period</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">WaterinfoException</span><span class="p">(</span>
                <span class="s2">&quot;Date information should be provided by a combination of maximum 2 &quot;</span>
                <span class="s2">&quot;parameters out of from / to / period&quot;</span>
            <span class="p">)</span>

        <span class="c1"># if only &#39;to&#39; provided, error</span>
        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">start</span><span class="p">)</span> <span class="ow">and</span> <span class="n">end</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="n">period</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">WaterinfoException</span><span class="p">(</span>
                <span class="s2">&quot;Date information should be provided by providing a &quot;</span>
                <span class="s2">&quot;from or period input&quot;</span>
            <span class="p">)</span>

        <span class="n">period_info</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">start</span><span class="p">:</span>
            <span class="n">period_info</span><span class="p">[</span><span class="s2">&quot;from&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_date</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">timezone</span><span class="o">=</span><span class="n">timezone</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">end</span><span class="p">:</span>
            <span class="n">period_info</span><span class="p">[</span><span class="s2">&quot;to&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_date</span><span class="p">(</span><span class="n">end</span><span class="p">,</span> <span class="n">timezone</span><span class="o">=</span><span class="n">timezone</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">period</span><span class="p">:</span>
            <span class="n">period_info</span><span class="p">[</span><span class="s2">&quot;period&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_period_format</span><span class="p">(</span><span class="n">period</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">period_info</span>

<div class="viewcode-block" id="Waterinfo.get_timeseries_values">
<a class="viewcode-back" href="../../api/reference.html#pywaterinfo.Waterinfo.get_timeseries_values">[docs]</a>
    <span class="k">def</span> <span class="nf">get_timeseries_values</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">ts_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">timeseriesgroup_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">period</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">start</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">end</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get time series data from waterinfo.be</span>

<span class="sd">        Using the ts_id codes or group identifiers and by providing a given date</span>
<span class="sd">        period, download the corresponding time series from the waterinfo.be website.</span>
<span class="sd">        Each identifier ts_id corresponds to a given variable-location-frequency</span>
<span class="sd">        combination (e.g. precipitation, Waregem, daily). When interested in daily,</span>
<span class="sd">        monthly, yearly aggregates look for these identifiers in order to overcome</span>
<span class="sd">        too many/large requests.</span>

<span class="sd">        Note: The usage of &#39;start&#39; and &#39;end&#39; instead of the API default from/to is done</span>
<span class="sd">        to avoid the usage of from, which is a protected name in Python.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        ts_id : str</span>
<span class="sd">            single or multiple ts_id values, comma-separated</span>
<span class="sd">        timeseriesgroup_id : str</span>
<span class="sd">            single or multiple group identifiers, comma-separated</span>
<span class="sd">        period : str</span>
<span class="sd">            input string according to format required by waterinfo: the period string</span>
<span class="sd">            is provided as P#Y#M#DT#H#M#S, with P defines `Period`, each # is an</span>
<span class="sd">            integer value and the codes define the number of...</span>
<span class="sd">            Y - years M - months D - days T required if information about sub-day</span>
<span class="sd">            resolution is present H - hours D - days M - minutes S - seconds Instead</span>
<span class="sd">            of D (days), the usage of W - weeks is possible as well.</span>
<span class="sd">            Examples of valid period strings: P3D, P1Y, P1DT12H, PT6H, P1Y6M3DT4H20M30S.</span>
<span class="sd">        start : datetime | str</span>
<span class="sd">            Either Python datetime object or a string which can be interpreted</span>
<span class="sd">            as a valid Timestamp.</span>
<span class="sd">        end : datetime | str</span>
<span class="sd">            Either Python datetime object or a string which can be interpreted</span>
<span class="sd">            as a valid Timestamp.</span>
<span class="sd">        kwargs :</span>
<span class="sd">            Additional query parameter options as documented by KIWIS waterinfo API,</span>
<span class="sd">            see `API documentation &lt;https://download.waterinfo.be/tsmdownload/</span>
<span class="sd">            KiWIS/KiWIS?service=kisters&amp;type=QueryServices&amp;format=html&amp;</span>
<span class="sd">            request=getrequestinfo&gt;`_</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        pd.DataFrame</span>
<span class="sd">            DataFrame with for time series data and datetime in UTC.</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        &gt;&gt;&gt; from pywaterinfo import Waterinfo</span>
<span class="sd">        &gt;&gt;&gt; vmm = Waterinfo(&quot;vmm&quot;)</span>
<span class="sd">        &gt;&gt;&gt;</span>
<span class="sd">        &gt;&gt;&gt; # get last day of data for the time series with ID 78124042</span>
<span class="sd">        &gt;&gt;&gt; df = vmm.get_timeseries_values(78124042, period=&quot;P1D&quot;)</span>
<span class="sd">        &gt;&gt;&gt;</span>
<span class="sd">        &gt;&gt;&gt; # get last day data of time series with ID 78124042 with subset of columns</span>
<span class="sd">        &gt;&gt;&gt; my_columns = (&quot;Timestamp,Value,Interpolation Type,Quality Code,Quality&quot;</span>
<span class="sd">        ...               &quot; Code Name,Quality Code Description&quot;)</span>
<span class="sd">        &gt;&gt;&gt; df = vmm.get_timeseries_values(78124042, period=&quot;P1D&quot;,</span>
<span class="sd">        ...                                returnfields=my_columns)</span>
<span class="sd">        &gt;&gt;&gt;</span>
<span class="sd">        &gt;&gt;&gt; # get the data for ts_id 60992042 and 60968042 (Moerbeke_P and Waregem_P)</span>
<span class="sd">        &gt;&gt;&gt; # for 20190502 till 20190503</span>
<span class="sd">        &gt;&gt;&gt; # Note: UTC as time unit is used as input and asked as output by default</span>
<span class="sd">        &gt;&gt;&gt; df = vmm.get_timeseries_values(&quot;60992042,60968042&quot;,</span>
<span class="sd">        ...                           start=&quot;20190502&quot;, end=&quot;20190503&quot;)</span>
<span class="sd">        &gt;&gt;&gt;</span>
<span class="sd">        &gt;&gt;&gt; # One can overwrite the timezone to request data in another time zone:</span>
<span class="sd">        &gt;&gt;&gt; df = vmm.get_timeseries_values(&quot;60992042,60968042&quot;,</span>
<span class="sd">        ...                           start=&quot;20190502&quot;, end=&quot;20190503&quot;, timezone=&quot;CET&quot;)</span>
<span class="sd">        &gt;&gt;&gt;</span>
<span class="sd">        &gt;&gt;&gt; # get the data for all stations from groups 192900 (yearly rain sum)</span>
<span class="sd">        &gt;&gt;&gt; # and 192895 (yearly discharge average) for the last 2 years</span>
<span class="sd">        &gt;&gt;&gt; df = vmm.get_timeseries_values(timeseriesgroup_id=&quot;192900,192895&quot;,</span>
<span class="sd">        ...                                period=&quot;P2Y&quot;)  # doctest: +SKIP</span>
<span class="sd">        &gt;&gt;&gt;</span>
<span class="sd">        &gt;&gt;&gt; hic = Waterinfo(&quot;hic&quot;)</span>
<span class="sd">        &gt;&gt;&gt;</span>
<span class="sd">        &gt;&gt;&gt; # get last day of data for the time series with ID 44223010</span>
<span class="sd">        &gt;&gt;&gt; df = hic.get_timeseries_values(ts_id=&quot;44223010&quot;, period=&quot;P1D&quot;)</span>
<span class="sd">        &gt;&gt;&gt;</span>
<span class="sd">        &gt;&gt;&gt; # get last day data of time series with ID 44223010 with subset of columns</span>
<span class="sd">        &gt;&gt;&gt; df = hic.get_timeseries_values(ts_id=&quot;44223010&quot;, period=&quot;P1D&quot;,</span>
<span class="sd">        ...          returnfields=&quot;Timestamp,Value,Interpolation Type,Quality Code&quot;)</span>
<span class="sd">        &gt;&gt;&gt;</span>
<span class="sd">        &gt;&gt;&gt; # get last 10 hours data from Antwerpen tij/Zeeschelde (ts_id 53995010)</span>
<span class="sd">        &gt;&gt;&gt; # containing &#39;Tide Number&#39; info. Tide number is useful when requesting</span>
<span class="sd">        &gt;&gt;&gt; # tidal extremes (high water/low water, &#39;ts_name&#39;=Pv.HWLW)</span>
<span class="sd">        &gt;&gt;&gt; df = hic.get_timeseries_values(ts_id=&quot;53995010&quot;, period=&quot;PT10H&quot;,</span>
<span class="sd">        ...          returnfields=&quot;Timestamp,Value,Tide Number&quot;)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s2">&quot;timezone&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">timezone</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;timezone&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">timezone</span> <span class="o">=</span> <span class="s2">&quot;UTC&quot;</span>

        <span class="c1"># check the period information</span>
        <span class="n">period_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_period</span><span class="p">(</span>
            <span class="n">start</span><span class="o">=</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="n">end</span><span class="p">,</span> <span class="n">period</span><span class="o">=</span><span class="n">period</span><span class="p">,</span> <span class="n">timezone</span><span class="o">=</span><span class="n">timezone</span>
        <span class="p">)</span>

        <span class="c1"># add either ts_id or timeseriesgroup_id</span>
        <span class="k">if</span> <span class="n">ts_id</span> <span class="ow">and</span> <span class="n">timeseriesgroup_id</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">WaterinfoException</span><span class="p">(</span>
                <span class="s2">&quot;A combination of ts_id and timeseriesgroup_id is not possible, &quot;</span>
                <span class="s2">&quot;use one of these three&quot;</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ts_id</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">timeseriesgroup_id</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">WaterinfoException</span><span class="p">(</span><span class="s2">&quot;Either ts_id or timeseriesgroup_id is required.&quot;</span><span class="p">)</span>

        <span class="c1"># collect all possible returnfields</span>
        <span class="n">returnfields</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_kiwis_info</span><span class="p">[</span><span class="s2">&quot;getTimeseriesValues&quot;</span><span class="p">][</span><span class="s2">&quot;Returnfields&quot;</span><span class="p">][</span>
            <span class="s2">&quot;Content&quot;</span>
        <span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="n">all_returnfields</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">field</span> <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">returnfields</span> <span class="k">if</span> <span class="n">field</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">DECODE_ERRORS</span>
        <span class="p">]</span>

        <span class="n">query_param</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="n">request</span><span class="o">=</span><span class="s2">&quot;getTimeseriesValues&quot;</span><span class="p">,</span>
            <span class="n">ts_id</span><span class="o">=</span><span class="n">ts_id</span><span class="p">,</span>
            <span class="n">timeseriesgroup_id</span><span class="o">=</span><span class="n">timeseriesgroup_id</span><span class="p">,</span>
            <span class="n">returnfields</span><span class="o">=</span><span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">all_returnfields</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="n">query_param</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">period_info</span><span class="p">)</span>
        <span class="n">query_param</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="n">data</span><span class="p">,</span> <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request_kiwis</span><span class="p">(</span><span class="n">query_param</span><span class="p">)</span>

        <span class="c1"># All metadata of time series (except of columns, data and rows) converted</span>
        <span class="c1"># to additional columns in df in order to concat all of them while keeping the</span>
        <span class="c1"># information to trace the origin</span>
        <span class="n">time_series</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">section</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">section</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">],</span> <span class="n">columns</span><span class="o">=</span><span class="n">section</span><span class="p">[</span><span class="s2">&quot;columns&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">key_name</span> <span class="ow">in</span> <span class="n">section</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">key_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;columns&quot;</span><span class="p">,</span> <span class="s2">&quot;data&quot;</span><span class="p">,</span> <span class="s2">&quot;rows&quot;</span><span class="p">):</span>
                    <span class="n">df</span><span class="p">[</span><span class="n">key_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">section</span><span class="p">[</span><span class="n">key_name</span><span class="p">]</span>
            <span class="c1"># convert datetime objects to Pandas timestamp</span>
            <span class="k">if</span> <span class="s2">&quot;Timestamp&quot;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="c1"># round trip via UTC to handle mixed time series</span>
                <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Timestamp&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span>
                    <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Timestamp&quot;</span><span class="p">],</span> <span class="n">utc</span><span class="o">=</span><span class="kc">True</span>
                <span class="p">)</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">tz_convert</span><span class="p">(</span><span class="n">timezone</span><span class="p">)</span>
            <span class="n">time_series</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">time_series</span><span class="p">)</span></div>


<div class="viewcode-block" id="Waterinfo.get_timeseries_value_layer">
<a class="viewcode-back" href="../../api/reference.html#pywaterinfo.Waterinfo.get_timeseries_value_layer">[docs]</a>
    <span class="k">def</span> <span class="nf">get_timeseries_value_layer</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">timeseriesgroup_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ts_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">bbox</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get metadata and last measured value for group of stations</span>

<span class="sd">        Either ts_id, timeseriesgroup_id or bbox can be used to request data. The</span>
<span class="sd">        function provides metadata and the last measured value for the group of</span>
<span class="sd">        ids/stations.</span>

<span class="sd">        Note, by using an additional &#39;date&#39; argument, the data value of another moment</span>
<span class="sd">        can be requested as well.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        ts_id : str</span>
<span class="sd">            single or multiple ts_id values, comma-separated</span>
<span class="sd">        timeseriesgroup_id : str</span>
<span class="sd">            single or multiple group identifiers, comma-separated</span>
<span class="sd">        bbox :</span>
<span class="sd">            Comma separated list with four values in order min_x, min_y, max_x, max_y;</span>
<span class="sd">            use &#39;crs&#39; parameter to choose between local and global coordinates. fields</span>
<span class="sd">            stationparameter_no and ts_shortname are required for bbox; the function</span>
<span class="sd">            will select 0 or 1 timeseries per station in the area according to filters</span>
<span class="sd">        kwargs :</span>
<span class="sd">            Additional query parameter options as documented by KIWIS waterinfo API, see</span>
<span class="sd">            `API documentation &lt;https://download.waterinfo.be/tsmdownload/</span>
<span class="sd">            KiWIS/KiWIS?service=kisters&amp;type=QueryServices&amp;format=html&amp;</span>
<span class="sd">            request=getrequestinfo&gt;`_</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        pd.DataFrame</span>
<span class="sd">            DataFrame with for each time series in the group a row containing</span>
<span class="sd">            measurement and metadata</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        &gt;&gt;&gt; from pywaterinfo import Waterinfo</span>
<span class="sd">        &gt;&gt;&gt; vmm = Waterinfo(&quot;vmm&quot;)</span>
<span class="sd">        &gt;&gt;&gt;</span>
<span class="sd">        &gt;&gt;&gt; # get the metadata and last measured value on a single time series</span>
<span class="sd">        &gt;&gt;&gt; df = vmm.get_timeseries_value_layer(ts_id=78124042)</span>
<span class="sd">        &gt;&gt;&gt;</span>
<span class="sd">        &gt;&gt;&gt; # get the metadata and last measured value of all members of a</span>
<span class="sd">        &gt;&gt;&gt; # time series group</span>
<span class="sd">        &gt;&gt;&gt; df = vmm.get_timeseries_value_layer(timeseriesgroup_id=192928)</span>
<span class="sd">        &gt;&gt;&gt;</span>
<span class="sd">        &gt;&gt;&gt; # get the measured value of all members of a time series group on</span>
<span class="sd">        &gt;&gt;&gt; # a given time stamp</span>
<span class="sd">        &gt;&gt;&gt; df = vmm.get_timeseries_value_layer(timeseriesgroup_id=192928,</span>
<span class="sd">        ...                                     date=&quot;20190501&quot;)</span>
<span class="sd">        &gt;&gt;&gt;</span>
<span class="sd">        &gt;&gt;&gt; # Limit the number of returned fields/columns in response</span>
<span class="sd">        &gt;&gt;&gt; df = vmm.get_timeseries_value_layer(&quot;192780&quot;,</span>
<span class="sd">        ...     returnfields=&quot;timestamp,ts_value&quot;, metadata=&quot;false&quot;)</span>
<span class="sd">        &gt;&gt;&gt;</span>
<span class="sd">        &gt;&gt;&gt; hic = Waterinfo(&quot;hic&quot;)</span>
<span class="sd">        &gt;&gt;&gt;</span>
<span class="sd">        &gt;&gt;&gt; # get the metadata and last measured value of the oxygen concentration</span>
<span class="sd">        &gt;&gt;&gt; # (group id 156207) and conductivity (group id 156173) combined</span>
<span class="sd">        &gt;&gt;&gt; df = hic.get_timeseries_value_layer(timeseriesgroup_id=&quot;156207,156173&quot;)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># hard coded set of metadata return fields as only in description</span>
        <span class="c1"># field of queryinfo</span>
        <span class="n">md_returnfields</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;ts_id,ts_path,ts_name,ts_shortname,station_no,station_id,station_name,&quot;</span>
            <span class="s2">&quot;stationparameter_name,stationparameter_no,stationparameter_longname,&quot;</span>
            <span class="s2">&quot;ts_unitname,ts_unitsymbol,parametertype_id,parametertype_name,ca_sta&quot;</span>
        <span class="p">)</span>
        <span class="n">ca_sta_returnfields</span> <span class="o">=</span> <span class="s2">&quot;dataprovider&quot;</span>

        <span class="c1"># add either ts_id, timeseriesgroup_id or bbox to the query</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="p">(</span><span class="n">ts_id</span> <span class="ow">and</span> <span class="n">timeseriesgroup_id</span> <span class="ow">and</span> <span class="n">bbox</span><span class="p">)</span>
            <span class="ow">or</span> <span class="p">(</span><span class="n">ts_id</span> <span class="ow">and</span> <span class="n">timeseriesgroup_id</span><span class="p">)</span>
            <span class="ow">or</span> <span class="p">(</span><span class="n">timeseriesgroup_id</span> <span class="ow">and</span> <span class="n">bbox</span><span class="p">)</span>
            <span class="ow">or</span> <span class="p">(</span><span class="n">ts_id</span> <span class="ow">and</span> <span class="n">bbox</span><span class="p">)</span>
        <span class="p">):</span>
            <span class="k">raise</span> <span class="n">WaterinfoException</span><span class="p">(</span>
                <span class="s2">&quot;A combination of ts_id, timeseriesgroup_id or bbox not possible, &quot;</span>
                <span class="s2">&quot;use one of these three&quot;</span>
            <span class="p">)</span>
        <span class="n">query_param</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="n">request</span><span class="o">=</span><span class="s2">&quot;getTimeseriesValueLayer&quot;</span><span class="p">,</span>
            <span class="n">metadata</span><span class="o">=</span><span class="s2">&quot;TRUE&quot;</span><span class="p">,</span>
            <span class="n">md_returnfields</span><span class="o">=</span><span class="n">md_returnfields</span><span class="p">,</span>
            <span class="n">ca_sta_returnfields</span><span class="o">=</span><span class="n">ca_sta_returnfields</span><span class="p">,</span>
            <span class="n">ts_id</span><span class="o">=</span><span class="n">ts_id</span><span class="p">,</span>
            <span class="n">timeseriesgroup_id</span><span class="o">=</span><span class="n">timeseriesgroup_id</span><span class="p">,</span>
            <span class="n">bbox</span><span class="o">=</span><span class="n">bbox</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">query_param</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">data</span><span class="p">,</span> <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request_kiwis</span><span class="p">(</span><span class="n">query_param</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="p">)</span></div>


<div class="viewcode-block" id="Waterinfo.get_group_list">
<a class="viewcode-back" href="../../api/reference.html#pywaterinfo.Waterinfo.get_group_list">[docs]</a>
    <span class="k">def</span> <span class="nf">get_group_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">group_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">group_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get a list of time series and station groups</span>

<span class="sd">        The function provides the existing group identifiers. These group_ids enable</span>
<span class="sd">        the user to request all values of a given group at the same time (method</span>
<span class="sd">        `get_timeseries_value_layer` or `get_timeseries_values`).</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        group_name : str</span>
<span class="sd">            Name of the time series group, can contain wildcards, e.g. &#39;*Download*&#39;</span>
<span class="sd">        group_type : &#39;station&#39; | &#39;parameter&#39; | &#39;timeseries&#39;</span>
<span class="sd">            Specify the type station, parameter or timeseries</span>
<span class="sd">        kwargs :</span>
<span class="sd">            Additional queryfields as accepted by the KIWIS call getGroupList, see</span>
<span class="sd">            `API documentation &lt;https://download.waterinfo.be/tsmdownload/</span>
<span class="sd">            KiWIS/KiWIS?service=kisters&amp;type=QueryServices&amp;format=html&amp;</span>
<span class="sd">            request=getrequestinfo&gt;`_</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        pd.DataFrame</span>
<span class="sd">            DataFrame with an overview of the groups provided by the API</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        &gt;&gt;&gt; from pywaterinfo import Waterinfo</span>
<span class="sd">        &gt;&gt;&gt; vmm = Waterinfo(&quot;vmm&quot;)</span>
<span class="sd">        &gt;&gt;&gt;</span>
<span class="sd">        &gt;&gt;&gt; # all available groupid&#39;s provided by VMM</span>
<span class="sd">        &gt;&gt;&gt; df = vmm.get_group_list()</span>
<span class="sd">        &gt;&gt;&gt;</span>
<span class="sd">        &gt;&gt;&gt; # all available groupid&#39;s provided by VMM that represent a time series</span>
<span class="sd">        &gt;&gt;&gt; df = vmm.get_group_list(group_type=&#39;timeseries&#39;)</span>
<span class="sd">        &gt;&gt;&gt;</span>
<span class="sd">        &gt;&gt;&gt; # all available groupid&#39;s  provided by VMM containing &#39;Download&#39; in</span>
<span class="sd">        &gt;&gt;&gt; # the group name</span>
<span class="sd">        &gt;&gt;&gt; df = vmm.get_group_list(group_name=&#39;*Download*&#39;)</span>
<span class="sd">        &gt;&gt;&gt;</span>
<span class="sd">        &gt;&gt;&gt; hic = Waterinfo(&quot;hic&quot;)</span>
<span class="sd">        &gt;&gt;&gt;</span>
<span class="sd">        &gt;&gt;&gt; # all available groupid&#39;s provided by HIC</span>
<span class="sd">        &gt;&gt;&gt; df = hic.get_group_list()</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">group_type</span> <span class="ow">and</span> <span class="n">group_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;station&quot;</span><span class="p">,</span> <span class="s2">&quot;parameter&quot;</span><span class="p">,</span> <span class="s2">&quot;timeseries&quot;</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="n">WaterinfoException</span><span class="p">(</span>
                <span class="s2">&quot;Invalid group_type, use &#39;station&#39;, &#39;parameter&#39; or &#39;timeseries&#39;&quot;</span>
            <span class="p">)</span>

        <span class="n">query_param</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="n">request</span><span class="o">=</span><span class="s2">&quot;getGroupList&quot;</span><span class="p">,</span> <span class="n">group_name</span><span class="o">=</span><span class="n">group_name</span><span class="p">,</span> <span class="n">group_type</span><span class="o">=</span><span class="n">group_type</span>
        <span class="p">)</span>

        <span class="n">query_param</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">data</span><span class="p">,</span> <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request_kiwis</span><span class="p">(</span><span class="n">query_param</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="n">columns</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span></div>


<div class="viewcode-block" id="Waterinfo.get_timeseries_list">
<a class="viewcode-back" href="../../api/reference.html#pywaterinfo.Waterinfo.get_timeseries_list">[docs]</a>
    <span class="k">def</span> <span class="nf">get_timeseries_list</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">station_no</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">stationparameter_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get time series at given station an/or time series which provide</span>
<span class="sd">        certain parameter</span>

<span class="sd">        The station_no and stationparameter_name are provided as arguments, as these</span>
<span class="sd">        represent our typical use cases: station_no and stationparameter_name are shown</span>
<span class="sd">        on the waterinfo.be download pages as respectively the &#39;station_number&#39; and</span>
<span class="sd">        &#39;parameter&#39; column.</span>

<span class="sd">        By default all returnfields are provided in the returned dataframe, but this</span>
<span class="sd">        can be overridden by the user by providing the returnfields as an additional</span>
<span class="sd">        argument.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        station_no : str</span>
<span class="sd">            single or multiple station_no values, comma-separated</span>
<span class="sd">        stationparameter_name : str</span>
<span class="sd">            single or multiple stationparameter_name values, comma-separated</span>
<span class="sd">        kwargs :</span>
<span class="sd">            Additional queryfields as accepted by the KIWIS call getTimeseriesList, see</span>
<span class="sd">            `API docoumentation &lt;https://download.waterinfo.be/tsmdownload/</span>
<span class="sd">            KiWIS/KiWIS?service=kisters&amp;type=QueryServices&amp;format=html&amp;</span>
<span class="sd">            request=getrequestinfo&gt;`_</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        pd.DataFrame</span>
<span class="sd">            DataFrame with each row the time series metadata</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        &gt;&gt;&gt; from pywaterinfo import Waterinfo</span>
<span class="sd">        &gt;&gt;&gt; vmm = Waterinfo(&quot;vmm&quot;)</span>
<span class="sd">        &gt;&gt;&gt;</span>
<span class="sd">        &gt;&gt;&gt; # for given station ME09_012, which time series are available?</span>
<span class="sd">        &gt;&gt;&gt; df = vmm.get_timeseries_list(station_no=&quot;ME09_012&quot;) # doctest: +SKIP</span>
<span class="sd">        &gt;&gt;&gt;</span>
<span class="sd">        &gt;&gt;&gt; # for a given parameter PET, which time series are available?</span>
<span class="sd">        &gt;&gt;&gt; df = vmm.get_timeseries_list(parametertype_name=&quot;PET&quot;) # doctest: +SKIP</span>
<span class="sd">        &gt;&gt;&gt;</span>
<span class="sd">        &gt;&gt;&gt; # for a given parameter PET and station ME09_012, which time series</span>
<span class="sd">        &gt;&gt;&gt; # are available?</span>
<span class="sd">        &gt;&gt;&gt; df = vmm.get_timeseries_list(parametertype_name=&quot;PET&quot;,</span>
<span class="sd">        ...                              station_no=&quot;ME09_012&quot;)</span>
<span class="sd">        &gt;&gt;&gt;</span>
<span class="sd">        &gt;&gt;&gt; # for a given parametertype_id 11502, which time series are available?</span>
<span class="sd">        &gt;&gt;&gt; df = vmm.get_timeseries_list(parametertype_id=&quot;11502&quot;)</span>
<span class="sd">        &gt;&gt;&gt;</span>
<span class="sd">        &gt;&gt;&gt; # only interested in a subset of the returned columns: ts_id, station_name,</span>
<span class="sd">        &gt;&gt;&gt; # stationparameter_longname</span>
<span class="sd">        &gt;&gt;&gt; df = vmm.get_timeseries_list(parametertype_id=&quot;11502&quot;,</span>
<span class="sd">        ...                returnfields=&quot;ts_id,station_name,stationparameter_longname&quot;)</span>
<span class="sd">        &gt;&gt;&gt;</span>
<span class="sd">        &gt;&gt;&gt; hic = Waterinfo(&quot;hic&quot;)</span>
<span class="sd">        &gt;&gt;&gt;</span>
<span class="sd">        &gt;&gt;&gt; # for a given parameter EC, which time series are available?</span>
<span class="sd">        &gt;&gt;&gt; df = hic.get_timeseries_list(parametertype_name=&quot;EC&quot;)</span>
<span class="sd">        &gt;&gt;&gt;</span>
<span class="sd">        &gt;&gt;&gt; # for a given station plu03a-1066, which time series are available?</span>
<span class="sd">        &gt;&gt;&gt; df = hic.get_timeseries_list(station_no=&quot;plu03a-1066&quot;)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">all_returnfields</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_kiwis_info</span><span class="p">[</span><span class="s2">&quot;getTimeseriesList&quot;</span><span class="p">][</span><span class="s2">&quot;Returnfields&quot;</span><span class="p">][</span><span class="s2">&quot;Content&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="p">)</span>
        <span class="c1"># custom-fix: remove &#39;ts_clientvalue##&#39; and &#39;datacart&#39; from returnfields</span>
        <span class="c1"># as these provide error</span>
        <span class="n">all_returnfields</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">field</span>
            <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">all_returnfields</span>
            <span class="k">if</span> <span class="n">field</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;ts_clientvalue##&quot;</span><span class="p">,</span> <span class="s2">&quot;datacart&quot;</span><span class="p">]</span>
        <span class="p">]</span>

        <span class="n">query_param</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="n">request</span><span class="o">=</span><span class="s2">&quot;getTimeseriesList&quot;</span><span class="p">,</span>
            <span class="n">station_no</span><span class="o">=</span><span class="n">station_no</span><span class="p">,</span>
            <span class="n">stationparameter_name</span><span class="o">=</span><span class="n">stationparameter_name</span><span class="p">,</span>
            <span class="n">returnfields</span><span class="o">=</span><span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">all_returnfields</span><span class="p">),</span>
        <span class="p">)</span>

        <span class="n">query_param</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">data</span><span class="p">,</span> <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request_kiwis</span><span class="p">(</span><span class="n">query_param</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;No matches.&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="n">columns</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span></div>
</div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2021, Fluves.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>